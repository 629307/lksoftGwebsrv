<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Инструкция — ИГС lksoftGwebsrv</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/style.css?v=2.2.4" />
    <style>
        .help-wrap { max-width: 1100px; margin: 0 auto; padding: 18px 16px 60px; }
        .help-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 14px; }
        .help-title { display:flex; align-items:center; gap:10px; }
        .help-title h1 { font-size: 20px; margin: 0; }
        .help-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 14px 14px; box-shadow: var(--shadow); }
        .help-grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
        .help-card h2 { font-size: 15px; margin: 0 0 8px; }
        .help-card h3 { font-size: 13px; margin: 10px 0 6px; color: var(--text-secondary); }
        .help-card p { margin: 6px 0; }
        .help-card ul { margin: 6px 0 0 18px; }
        .help-card li { margin: 4px 0; }
        .kbd { display:inline-block; padding:2px 6px; border:1px solid var(--border-color); border-radius:6px; background: rgba(255,255,255,0.04); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
        .muted { color: var(--text-muted); }
        .toc { display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
        .toc a { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:10px; border:1px solid var(--border-color); background: rgba(255,255,255,0.03); }
        .toc a:hover { text-decoration:none; background: rgba(255,255,255,0.06); }
        .hr { height:1px; background: var(--border-color); margin: 10px 0; opacity: 0.7; }
        @media (min-width: 900px) {
            .help-grid { grid-template-columns: 1fr 1fr; }
            .help-card.wide { grid-column: 1 / -1; }
        }
        @media print {
            .help-header .btn { display:none; }
            body { background: #fff; color: #000; }
        }
    </style>
</head>
<body>
    <div class="help-wrap">
        <div class="help-header">
            <div class="help-title">
                <i class="fas fa-circle-info" style="color: var(--accent-color);"></i>
                <div>
                    <h1>Инструкция — ИГС lksoftGwebsrv</h1>
                    <div class="muted">Описание функций и порядок работы по основным разделам системы.</div>
                </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-secondary btn-sm" onclick="window.print()"><i class="fas fa-print"></i> Печать</button>
                <button class="btn btn-secondary btn-sm" onclick="window.close()"><i class="fas fa-times"></i> Закрыть</button>
            </div>
        </div>

        <div class="help-card wide">
            <h2><i class="fas fa-list"></i> Быстрый переход</h2>
            <div class="toc">
                <a href="#map"><i class="fas fa-map"></i> Карта</a>
                <a href="#toolbar"><i class="fas fa-screwdriver-wrench"></i> Панель инструментов</a>
                <a href="#layers"><i class="fas fa-layer-group"></i> Слои и фильтры</a>
                <a href="#inventory"><i class="fas fa-clipboard-check"></i> Инвентаризация</a>
                <a href="#objects"><i class="fas fa-database"></i> Объекты</a>
                <a href="#tu"><i class="fas fa-clipboard-list"></i> ТУ</a>
                <a href="#incidents"><i class="fas fa-exclamation-triangle"></i> Инциденты</a>
                <a href="#contracts"><i class="fas fa-file-contract"></i> Контракты</a>
                <a href="#reports"><i class="fas fa-chart-bar"></i> Отчёты</a>
                <a href="#references"><i class="fas fa-book"></i> Справочники</a>
                <a href="#settings"><i class="fas fa-sliders-h"></i> Настройки</a>
                <a href="#hotkeys"><i class="fas fa-keyboard"></i> Горячие клавиши</a>
                <a href="#roles"><i class="fas fa-user-shield"></i> Роли</a>
            </div>
        </div>

        <div class="help-grid">
            <div class="help-card wide" id="map">
                <h2><i class="fas fa-map"></i> Карта</h2>
                <p>Карта — основной рабочий экран для просмотра объектов ИГС и работы с ними.</p>
                <ul>
                    <li><strong>Навигация</strong>: колесо мыши — масштаб, зажатая левая кнопка — перемещение.</li>
                    <li><strong>Координаты курсора</strong>: отображаются в левом нижнем углу в WGS84.</li>
                    <li><strong>Информация об объекте</strong>: клик по объекту открывает карточку справа.</li>
                    <li><strong>Спутник (WMTS)</strong>: кнопка <strong>“Спутник (WMTS)”</strong> в верхней панели включает/выключает спутниковый слой.</li>
                </ul>
                <div class="hr"></div>
                <p class="muted">Примечание: отображение объектов зависит от выбранных слоёв и фильтров.</p>
            </div>

            <div class="help-card" id="toolbar">
                <h2><i class="fas fa-screwdriver-wrench"></i> Панель инструментов карты</h2>
                <ul>
                    <li><strong>Добавить направление</strong> (<i class="fas fa-project-diagram"></i>): выберите 2 колодца на карте.</li>
                    <li><strong>Добавить колодец</strong> (<i class="fas fa-plus-circle"></i>): кликните на карте и заполните форму.</li>
                    <li><strong>Набить колодец</strong> (<i class="fas fa-plus-square"></i>): кликните по направлению и следуйте подсказкам.</li>
                    <li><strong>Добавить столбик</strong> (<i class="fas fa-map-marker-alt"></i>): кликните на карте и заполните форму.</li>
                    <li><strong>Добавить кабель в канализации (выбор каналов)</strong> (<i class="fas fa-wave-square"></i>): выберите направления/каналы маршрута и создайте кабель.</li>
                    <li><strong>Создать кабель в канализации по кратчайшему пути</strong> (<i class="fas fa-bezier-curve"></i>):</li>
                    <ul>
                        <li>Выберите 1-й и 2-й колодец — система предложит маршрут (кратчайший путь).</li>
                        <li>Если в направлении несколько каналов — потребуется выбрать канал(ы).</li>
                        <li>Далее можно выбирать 3-й, 4-й… колодцы — кабель будет достраиваться <strong>сегмент за сегментом</strong> (от предыдущего колодца к новому).</li>
                        <li><strong>Ограничение</strong>: маршрут не может содержать повтор одного и того же направления. Если без повторов пройти нельзя — будет сообщение <em>“Выбранный объект недостижим.”</em></li>
                        <li>После успешного создания кабеля режим автоматически выключается и очищает временные данные.</li>
                    </ul>
                    <li><strong>Переложить кабель в канализации</strong> (<i class="fas fa-random"></i>): переназначение маршрута кабеля по выбранным направлениям/каналам.</li>
                    <li><strong>Добавить кабель в грунте (ломаная)</strong> (<i class="fas fa-route"></i>): кликайте точки на карте, затем нажмите <strong>“Создать”</strong>.</li>
                    <li><strong>Добавить воздушный кабель (ломаная)</strong> (<i class="fas fa-broadcast-tower"></i>): кликайте точки на карте, затем нажмите <strong>“Создать”</strong>.</li>
                    <li><strong>Переместить точечный объект</strong> (<i class="fas fa-arrows-alt"></i>): для колодцев/столбиков — выберите объект и укажите новую позицию.</li>
                    <li><strong>Подсказки: номера колодцев</strong> (<i class="fas fa-tag"></i>) и <strong>Подсказки: длина направления</strong> (<i class="fas fa-ruler-horizontal"></i>).</li>
                    <li><strong>Показать координаты</strong> (<i class="fas fa-crosshairs"></i>): выводит широту/долготу рядом с точечными объектами (если включено).</li>
                    <li><strong>Легенда по собственникам</strong> (<i class="fas fa-palette"></i>): отображение по цвету собственника + легенда.</li>
                    <li><strong>Настройки по умолчанию</strong> (<i class="fas fa-sliders-h"></i>): персональные дефолты (в т.ч. контракт по умолчанию для кабелей).</li>
                    <li><strong>Режим ТУ</strong> (<i class="fas fa-clipboard-list"></i>): выбор ТУ для автоматической привязки создаваемых объектов.</li>
                    <li><strong>Режим инвентаризация</strong> (<i class="fas fa-clipboard-check"></i>): ввод количества кабелей по направлениям выбранного колодца (см. раздел “Инвентаризация”).</li>
                    <li><strong>Обновить карту</strong> (<i class="fas fa-sync-alt"></i>): перезагружает слои карты без изменения текущего масштаба и центра.</li>
                </ul>
                <p class="muted">Поддерживается отмена режимов и подсветок клавишей <span class="kbd">Esc</span>.</p>
            </div>

            <div class="help-card" id="layers">
                <h2><i class="fas fa-layer-group"></i> Слои и фильтры</h2>
                <h3>Слои</h3>
                <p>В боковой панели можно включать/выключать слои: Колодцы, Направления, Столбики, Кабели (грунт/воздух/канализация), а также <strong>Инвентаризация</strong>.</p>
                <ul>
                    <li><strong>Инвентаризация</strong>: при включении слоя автоматически выключаются остальные слои (кроме “Колодцы”), чтобы визуализация не перегружала карту. Слой инвентаризации отображается <strong>ниже</strong> колодцев.</li>
                    <li><strong>Подсказки “неучтенные кабели”</strong>: в строке слоя “Инвентаризация” справа есть кнопка‑переключатель, которая включает/выключает подписи значений на линиях.</li>
                    <li><strong>Предполагаемые кабели</strong>: управление находится <strong>в этой же строке</strong> слоя “Инвентаризация” (кнопка “Предполагаемые кабели”, выбор метода 1/2/3 и “Пересчитать”). При включении режима система временно переключает визуализацию на слой предполагаемых кабелей и отключает подсказки “неучтенные кабели”.</li>
                </ul>
                <h3>Фильтры</h3>
                <ul>
                    <li><strong>ТУ</strong>: показать объекты выбранного ТУ.</li>
                    <li><strong>Собственник</strong>: фильтрация по собственнику.</li>
                    <li><strong>Состояние</strong>: фильтрация по статусу.</li>
                    <li><strong>Контракт</strong>: фильтрация по контракту (показываются соответствующие кабели).</li>
                    <li><strong>Сброс</strong>: возвращает настройки фильтров и слоёв к значениям по умолчанию.</li>
                </ul>
            </div>

            <div class="help-card wide" id="inventory">
                <h2><i class="fas fa-clipboard-check"></i> Инвентаризация</h2>
                <h3>Инвентарные карточки (объект “Инвентарная карточка”)</h3>
                <ul>
                    <li>Инвентарная карточка привязана к одному колодцу и хранит: номер (формат <strong>ИНВ‑&lt;КОД собственника&gt;‑&lt;seq&gt;</strong>), дату заполнения, теги (бирки/собственники), количества кабелей по направлениям, вложения (файлы).</li>
                    <li>В “Объекты → Колодцы” в действиях доступны кнопки <strong>“Добавить инвентарную карточку”</strong> и <strong>“Открыть последнюю…”</strong> (если карточки есть).</li>
                </ul>

                <h3>Режим “Инвентаризация” на карте</h3>
                <ul>
                    <li>Нажмите кнопку <strong>“Режим инвентаризация”</strong> на панели инструментов.</li>
                    <li>Кликните по колодцу — на серединах линий его направлений появятся инпут‑окна для ввода количества кабелей.</li>
                    <li>Введите значения и нажмите <strong>“Создать”</strong> (кнопка появляется сверху по центру) или клавишу <span class="kbd">Enter</span> — откроется форма создания карточки с предзаполненными данными.</li>
                    <li><span class="kbd">Esc</span> — выход из режима.</li>
                </ul>

                <h3>Слой “Инвентаризация”</h3>
                <ul>
                    <li>Направления с данными инвентаризации рисуются толще и окрашиваются по градиенту по значению “неучтенные кабели”.</li>
                    <li>Остальные направления рисуются серым цветом <strong>#777777</strong>.</li>
                    <li>Наведение на направление показывает подсказку со списком кабелей, проходящих по его каналам.</li>
                </ul>
                <h3>Предполагаемые кабели (режим слоя)</h3>
                <ul>
                    <li>Включается кнопкой <strong>“Предполагаемые кабели”</strong> в строке слоя “Инвентаризация” (в боковой панели “Слои”).</li>
                    <li>Доступно 3 метода расчёта: <strong>1 — По магистральным графам</strong>, <strong>2 — По локальным графам</strong>, <strong>3 — По суммированным графам собственника</strong>.</li>
                    <li>Кнопка <strong>“Пересчитать”</strong> запускает построение предполагаемых кабелей и обновляет правую панель со списком.</li>
                    <li>Правую панель можно закрыть кнопкой <strong>✕</strong> — режим при этом выключится.</li>
                </ul>
            </div>

            <div class="help-card" id="objects">
                <h2><i class="fas fa-database"></i> Объекты</h2>
                <p>Раздел содержит вкладки: Колодцы, Направления, Каналы, Столбики, Кабели, ТУ.</p>
                <ul>
                    <li><strong>Добавить</strong>: создаёт объект выбранного типа.</li>
                    <li><strong>Редактировать</strong>: открывает форму редактирования.</li>
                    <li><strong>Удалить</strong>: удаляет запись (если есть права).</li>
                    <li><strong>Показать на карте</strong>: центрирует карту на объекте и подсвечивает его (для поддерживаемых типов).</li>
                    <li><strong>Фото</strong>: если у объекта есть фото — отображается кнопка просмотра миниатюр.</li>
                </ul>
                <p class="muted">Для каналов удаление доступно только для последнего канала в направлении.</p>
                <div class="hr"></div>
                <h3>Колодцы: дополнительные функции</h3>
                <ul>
                    <li><strong>Колодцы только с инвентаризационной карточкой</strong>: фильтр в верхней части списка колодцев.</li>
                    <li><strong>Колодцы требующие уточнения координат</strong>: фильтр показывает только колодцы с установленной галочкой “Требуется уточнить координаты”.</li>
                    <li>В форме “Редактирование колодца” есть галочка <strong>“Требуется уточнить координаты”</strong> (по умолчанию выключена).</li>
                    <li><strong>Опора</strong> (тип `pole`): отображается на карте треугольником; нумерация начинается с 100000.</li>
                    <li><strong>Ввод в здание</strong> (тип `input`): используется для точек ввода; отображается на карте как обычный колодец (стандартный маркер/подпись); нумерация начинается со значения настройки <strong>“Начальный номер вводного колодца”</strong> (параметр `input_well_number_start`).</li>
                </ul>
                <div class="hr"></div>
                <h3>Направления: описание объекта и связи</h3>
                <p><strong>Направление</strong> — линейный объект, который соединяет <strong>два колодца</strong>: начальный и конечный.</p>
                <ul>
                    <li><strong>Связь с колодцами</strong>: у направления всегда есть <strong>начальный</strong> и <strong>конечный</strong> колодец. Номер направления формируется автоматически как <strong>&lt;номер начального колодца&gt;-&lt;номер конечного колодца&gt;</strong> и обновляется при изменении номеров колодцев.</li>
                    <li><strong>Каналы</strong>: внутри направления есть объекты <strong>“Канал”</strong> (обычно 1…16), каждый канал — отдельный под‑объект с номером канала и состоянием/типом (если применимо).</li>
                    <li><strong>Длина</strong>: длина направления рассчитывается из геометрии и используется в расчётах длины кабелей в канализации.</li>
                </ul>

                <h3>Направления: дополнительные функции — статус “inbuilding”</h3>
                <p>Для направлений со статусом <strong>“inbuilding”</strong> (ввод в здание) действуют жёсткие правила:</p>
                <ul>
                    <li>Линия отображается пунктиром (цвет не меняется).</li>
                    <li>Собственник принудительно <strong>“Не указан”</strong> (даже если выбран другой при создании/редактировании).</li>
                    <li>Количество каналов всегда <strong>1</strong>; добавление дополнительных каналов запрещено.</li>
                </ul>
            </div>

            <div class="help-card" id="tu">
                <h2><i class="fas fa-clipboard-list"></i> ТУ (карточки)</h2>
                <p>ТУ — карточка, объединяющая объекты (колодцы, направления, кабели, столбики и т.д.).</p>
                <ul>
                    <li><strong>Поля ТУ</strong>: Номер (авто), Дата (необяз.), Основание (Запрос) (необяз.), Название, Тип ТУ, Описание.</li>
                    <li><strong>Вложения</strong>: можно прикреплять документы/изображения к ТУ (загрузка/скачивание/удаление).</li>
                    <li><strong>Режим ТУ</strong> на карте: выберите ТУ → создаваемые объекты получают статус <strong>planned</strong> и автоматически прикрепляются к выбранному ТУ.</li>
                </ul>
            </div>

            <div class="help-card" id="incidents">
                <h2><i class="fas fa-exclamation-triangle"></i> Инциденты</h2>
                <ul>
                    <li><strong>Создание</strong>: заполните карточку инцидента, при необходимости привяжите объекты.</li>
                    <li><strong>История</strong>: можно добавлять записи в историю.</li>
                    <li><strong>Вложения</strong>: документы/фото инцидента отображаются в карточке и доступны для скачивания.</li>
                </ul>
            </div>

            <div class="help-card" id="contracts">
                <h2><i class="fas fa-file-contract"></i> Контракты</h2>
                <p>Контракты — отдельный раздел (не в справочниках).</p>
                <ul>
                    <li><strong>Арендатор</strong> и <strong>Арендодатель</strong> выбираются из справочника собственников.</li>
                    <li>В отчёте по контрактам доступны расчёты и таблицы по выбранному контракту.</li>
                </ul>
            </div>

            <div class="help-card" id="reports">
                <h2><i class="fas fa-chart-bar"></i> Отчёты</h2>
                <ul>
                    <li>Доступны отчёты по объектам, контрактам, собственникам, инцидентам.</li>
                    <li>Отчёты прокручиваются внутри панели.</li>
                    <li>Кнопка <strong>Выгрузить</strong> позволяет скачать отчёт (где доступно) с выбором разделителя.</li>
                    <li><strong>Отчёт по инвентаризации</strong>: список направлений из сводной таблицы инвентаризации, действия “Показать на карте” и “Редактировать направление”, доступна выгрузка.</li>
                    <li><strong>Отчёт по контрактам</strong>: для кабелей доступны действия “Показать на карте”, “Добавить в контракт”/“Исключить из контракта” (где применимо).</li>
                </ul>
            </div>

            <div class="help-card" id="references">
                <h2><i class="fas fa-book"></i> Справочники</h2>
                <p>Справочники содержат типы/виды объектов, статусы, собственников, типы кабелей, каталог кабелей и др.</p>
                <ul>
                    <li>Права на изменение справочников зависят от роли.</li>
                    <li>В справочнике собственников можно задавать цвет для легенды.</li>
                </ul>
            </div>

            <div class="help-card" id="settings">
                <h2><i class="fas fa-sliders-h"></i> Настройки</h2>
                <ul>
                    <li><strong>Персональные настройки</strong>: большинство настроек сохраняются для текущего пользователя.</li>
                    <li><strong>Глобальная настройка</strong>: “Учитываемая длина кабеля в колодце” может менять только root.</li>
                    <li><strong>WMTS</strong>: в разделе “Настройка слоя WMTS” задаётся шаблон URL и параметры подстановки для спутникового слоя.</li>
                    <li><strong>Бэкапирование СУБД</strong> (админ): ручной бэкап, расписание (crontab) формируется динамически по “Периодичность (в часах)”, логирование и ротация выполняются CLI‑скриптом.</li>
                    <li><strong>Настройка ссылок меню</strong>: доступна как персональная настройка для роли “Пользователь”.</li>
                </ul>
                <div class="hr"></div>
                <h3>Настройки по умолчанию (на карте)</h3>
                <p>Панель <strong>“Настройки по умолчанию”</strong> открывается кнопкой <strong><i class="fas fa-sliders-h"></i></strong> на панели инструментов карты. Все значения сохраняются <strong>персонально</strong> для текущего пользователя и используются для предзаполнения форм добавления/редактирования.</p>
                <ul>
                    <li><strong>Тип (справочник) по умолчанию по видам объектов</strong>: для каждого вида объекта можно выбрать значение “типа/подтипа” из связанного справочника (например, для колодцев/столбиков/каналов — из “Типы объектов”, для кабелей — из “Типы кабелей”).</li>
                    <li><strong>Состояние по умолчанию</strong>: предвыбирается в формах создания объектов (где поле “Состояние” присутствует).</li>
                    <li><strong>Собственник по умолчанию</strong>: предвыбирается в формах создания объектов (где поле “Собственник” присутствует).</li>
                    <li><strong>Контракт по умолчанию</strong>: предвыбирается в формах создания/редактирования кабелей (все типы кабелей).</li>
                    <li><strong>Кабель (каталог) по умолчанию</strong>: предвыбирается в формах кабелей (маркировка/волоконность из каталога).</li>
                </ul>
                <p class="muted">Важно: для направлений со статусом <strong>“inbuilding”</strong> некоторые поля принудительно переопределяются (собственник “Не указан”, каналов всегда 1), даже если в дефолтах выбрано другое.</p>
            </div>

            <div class="help-card" id="hotkeys">
                <h2><i class="fas fa-keyboard"></i> Горячие клавиши</h2>
                <ul>
                    <li><span class="kbd">Esc</span>: выход из активного режима инструмента (добавление/перенос/инвентаризация и т.п.) и снятие подсветок.</li>
                    <li><span class="kbd">Ctrl</span> + клик по карте: добавить/убрать объект в множественное выделение (в обычном режиме).</li>
                    <li><span class="kbd">Ctrl</span> + протяжка мышью: прямоугольное выделение объектов на карте (выбираются объекты, полностью попавшие в рамку).</li>
                    <li><span class="kbd">Enter</span> в режиме инвентаризации: открыть создание инвентарной карточки по введённым значениям.</li>
                    <li>В настройках можно задать hotkey для инструментов карты в формате <strong>Alt + клавиша</strong> (одна цифра или латинская буква).</li>
                </ul>
            </div>

            <div class="help-card wide" id="roles">
                <h2><i class="fas fa-user-shield"></i> Роли и права</h2>
                <ul>
                    <li><strong>Администратор</strong>: полный доступ.</li>
                    <li><strong>Пользователь</strong>: доступ к большинству функций карты и объектов, без управления пользователями/частью системных настроек.</li>
                    <li><strong>Только чтение</strong>: только просмотр. На карте доступны подсказки и переключатели, создание/редактирование/удаление недоступны.</li>
                </ul>
                <div class="hr"></div>
                <h3>Особенности роли “Только чтение” (кабели по собственнику)</h3>
                <ul>
                    <li>Администратор может назначить пользователю “Только чтение” собственника из справочника.</li>
                    <li>После назначения пользователь будет видеть <strong>только кабели</strong>, у которых <strong>собственник совпадает</strong> с назначенным (для всех типов кабелей).</li>
                    <li>Если собственник не назначен — кабели не показываются.</li>
                </ul>
                <p class="muted">Если кнопки/действия недоступны — проверьте роль пользователя.</p>
            </div>
        </div>
    </div>
</body>
</html>

