# AI Agent Context — lksoftGwebsrv (ИГС)

Этот документ предназначен для передачи контекста следующему AI-агенту и ускорения безопасной разработки/поддержки.

## 1) Обзор проекта

### Цель системы
Веб‑портал ИГС (информационная географическая система) для ведения сетевой инфраструктуры (колодцы, направления, кабели и связанные сущности) с картографическим интерфейсом (Leaflet) и REST‑API на PHP.

### Бизнес‑логика (в двух словах)
- **Карта** — основной рабочий экран: просмотр/поиск/фильтрация объектов и выполнение операций редактирования.
- **Линейная сеть**: колодцы соединяются направлениями; внутри направления есть каналы; кабели привязываются к каналам/направлениям либо имеют собственную геометрию (грунт/воздух).
- **Инвентаризация**: ввод фактических количеств кабелей по направлениям для выбранного колодца, генерация инвентарных карточек, расчёт “неучтённых кабелей” и построение “предполагаемых кабелей”.
- **ТУ/Инциденты/Группы**: “карточки”/сущности для организационной и документальной связки объектов.
- **Справочники**: статусы, типы объектов, собственники, типы/каталог кабелей и т.п.
- **Настройки**: часть глобальная (админ/рут), часть персональная (для пользователя).

### Ключевые сущности (примерно по домену)
- **Колодец** (`wells`): точечный объект, имеет тип/вид (из справочника), номер, собственника, статус и геометрию.
- **Направление** (`channel_directions`): линия между двумя колодцами (`start_well_id`, `end_well_id`), имеет каналы, длину и отображение на карте.
- **Канал** (`cable_channels`): дочерний объект направления.
- **Кабели**:
  - “старые” типовые (`cables` с параметром `{type}` в API),
  - “унифицированные” (`unified_cables`) — рекомендуемая ветка развития.
- **Инвентарная карточка** (`inventory_cards`) + **вложения**.
- **Предполагаемые кабели** (расчёт/вывод/экспорт).
- **Собственники** (`owners`) + персональные **цвета легенды**.
- **Роли/пользователи** (`roles`, `users`, `user_sessions`).

### Роли (актуальная модель доступа)
Система использует “роль” + “permissions” из БД.
- **admin**: полный доступ (в т.ч. системные настройки, справочники, админ‑операции).
- **user**: рабочая роль (карта/объекты/операции), но часть настроек считается “системной” и скрыта/недоступна.
- **readonly**: только просмотр (часть функций/фильтров ограничена; запись/удаление запрещены).
- **root**: технический аккаунт (определяется логином `root`, имеет расширенные права на некоторые глобальные настройки).

## 2) Архитектура

### Backend
- Язык: **PHP**, собственный лёгкий роутер/контроллеры.
- Точка входа API: `api/index.php`.
- Маршрутизация: `src/Core/Router.php`.
- Авторизация: `src/Core/Auth.php` — сессионные токены в таблице `user_sessions`, токен передаётся как `Authorization: Bearer <token>`.
- Работа с БД: `src/Core/Database.php` (PDO + подготовленные запросы).
- Контроллеры: `src/Controllers/*Controller.php`.

### Frontend
- “Тонкий” фронтенд без сборки: `index.html` + `assets/js/*.js` + `assets/css/style.css`.
- Карта: Leaflet (основная логика в `assets/js/map.js`, UI/настройки/панели — `assets/js/app.js`).
- API‑клиент: `assets/js/api.js`.

### API
- Формат: JSON (и также экспортные endpoints).
- Большинство маршрутов защищены middleware `auth` в `api/index.php`.
- Примерный префикс: `/api/...`.

### База данных
- PostgreSQL (см. `config/database.php`, схема: `lksofyGwebsrv-schema.sql`).
- Важные таблицы:
  - `users`, `roles`, `user_sessions`
  - `wells`, `channel_directions`, `cable_channels`
  - `unified_cables` (и “старые” `cables_*`/`cables`)
  - `inventory_cards`, `inventory_attachments`
  - `audit_log`
  - справочники: `object_kinds`, `object_status`, `owners`, и др.

### Внешние интеграции/зависимости
- Leaflet + плагины.
- WMTS/тайлы карт (настраивается).
- Клиентские библиотеки могут подгружаться из CDN (например, `html2canvas`, `jsPDF` — если включены в `index.html`).

## 3) Структура проекта (важное)

### Ключевые директории
- `api/` — entrypoint API.
- `src/` — backend (Core + Controllers).
- `config/` — конфиги приложения и БД.
- `assets/js/` — frontend‑логика (App/Map/API).
- `assets/css/` — стили.
- `storage/` — служебные данные/CLI (бэкапы и т.п.).
- `uploads/` — загружаемые файлы (вложения/фото); требует корректных прав и ограничений.
- `vendor/` — зависимости PHP (autoload).

### Ключевые файлы
- `index.html` — основной UI.
- `assets/js/app.js` — UI, панели, настройки, модалки, интеграция с `MapManager`.
- `assets/js/map.js` — Leaflet‑карта, слои, порядок слоёв, подсветки, инвентаризация, инструменты рисования/создания.
- `assets/js/api.js` — методы запросов к API.
- `api/index.php` — роутинг API, middleware, обработка ошибок, CORS.
- `src/Core/Auth.php` — логика ролей/прав.
- `src/Core/Database.php` — PDO, подготовленные запросы.
- `src/Controllers/*` — доменная логика + RBAC на уровне эндпоинтов.
- `instructions.html` — пользовательская инструкция.
- `.htaccess`, `nginx.conf` — веб‑сервер/проксирование (в зависимости от окружения).

## 4) Основные сценарии работы

### Инвентаризация
- Пользователь включает **режим/слой “Инвентаризация”** на карте.
- Выбирает колодец → вводит количества по направлениям.
- Создаёт **инвентарную карточку**, прикладывает файлы (вложения).
- Система считает “неучтённые кабели”, строит “предполагаемые кабели”, даёт экспорт/отчёты.

### Загрузка/выгрузка
- Экспорт/выгрузки реализованы отдельными API endpoints (например, `/export`).
- Импорт: CSV/MapInfo (`ImportController`), а также текстовый импорт колодцев (`WellController`).
- Важно: импорт и загрузки файлов — зона повышенного риска (валидация, размер, типы, path traversal).

### Управление ТУ
- ТУ используются как “контекст” — при активном режиме ТУ создаваемые объекты получают нужные статусы/привязки.

### Роли пользователей
- `readonly`: запрет на запись/удаление; часть фильтров/операций и некоторые панели скрыты/отключены.
- `user`: рабочие функции доступны, но часть **системных** настроек (глобальные) недоступна.
- `admin/root`: доступ к системным настройкам, админ‑панелям, бэкапам и т.п.

## 5) Текущие ограничения и технический долг
- **CORS**: в `api/index.php` сейчас стоит `Access-Control-Allow-Origin: *` — удобно для разработки, но в production лучше ограничивать доменами.
- **Security headers**: нет централизованной установки заголовков безопасности (желательно на уровне Nginx/Apache и/или в entrypoint).
- **CSRF**: API использует Bearer‑токен; классический CSRF менее критичен, но при появлении cookie‑авторизации потребуется CSRF‑защита.
- **CSP**: жёсткий CSP может сломать текущую страницу (CDN, inline‑скрипты/стили), внедрять осторожно.
- **RBAC**: часть проверок есть на backend, но важно не полагаться только на frontend‑скрытие кнопок.
- **Загрузки файлов**: требуется систематизация лимитов, белых списков MIME/расширений, безопасного имени файла, проверки прав доступа к скачиванию.
- **Логи**: при `debug=true` могут утекать детали исключений; для production нужно выключать debug и настраивать ротацию.

## 6) Где можно безопасно продолжать разработку
- Frontend‑улучшения (UI/UX), если они **не меняют** формат API.
- Новые отчёты/экспортные формы как отдельные endpoints.
- Расширение карты: улучшение подсветок/панелей/режимов рисования при сохранении существующих API контрактов.
- Рефакторинг настроек: чётко разделять **персональные** и **глобальные** настройки, всегда дублировать RBAC на backend.

## 7) Как запускать проект (в общих чертах)

### Требования
- PHP (с PDO pgsql), web‑server (Nginx/Apache), PostgreSQL.

### Конфигурация
- `config/app.php` — общие настройки (в т.ч. `debug`, `timezone`, lifetime сессий).
- `config/database.php` — подключение к БД.

### Запуск (dev)
- Развернуть web‑server так, чтобы:
  - статические файлы (`index.html`, `assets/`, `uploads/`) отдавались напрямую,
  - запросы к `/api/*` проксировались на `api/index.php`.

### Запуск (prod)
- Обязательно: HTTPS, ограничения CORS по доменам, security headers, ротация логов, бэкапы БД, ограничение размера запросов/загрузок.

